<?php

/**
 * @file
 * Contains culturefeed_content.module.
 */

define('CULTUREFEED_CONTENT_DEFAULT_ROWS', 10);
define('CULTUREFEED_CONTENT_DEFAULT_SORT', 'date');
define('CULTUREFEED_CONTENT_DEFAULT_TITLE', t('Our selection'));

/**
 * Implements hook_field_create_instance().
 */
function culturefeed_content_field_create_instance($instance) {

  if ($instance['widget']['type'] == 'culturefeed_content_default') {
    // Set some default values.
    $instance['default_value'] = array(
      array(
        'rows' => CULTUREFEED_CONTENT_DEFAULT_ROWS,
        'sort' => CULTUREFEED_CONTENT_DEFAULT_SORT,
        'title' => CULTUREFEED_CONTENT_DEFAULT_TITLE,
      ),
    );
    field_update_instance($instance);
  }
}

/**
 * Validation handler for the CultureFeed content field.
 */
function culturefeed_content_field_culturefeed_content_validate($element, &$form_state, $form) {

  $parents = $element['#parents'];
  $parents[] = 'wrapper';
  $values = drupal_array_get_nested_value($form_state['values'], $parents);
  $items = array(
    'title' => $values['title'],
    'query_string' => $values['query_string'],
    'filter_query' => $values['filter_query'],
    'rows' => ($values['rows'] || $values['rows'] == 0) ? $values['rows'] : CULTUREFEED_CONTENT_DEFAULT_ROWS,
    'sort' => $values['sort'],
    'types' => $values['types'],
    'what_categories' => serialize($form_state['values']['field_zoekopdracht'][LANGUAGE_NONE][0]['wrapper']['what']),
    'where_type' => $values['where']['where_type'],
    'where_equal' => (int)$values['where']['where_equal'],
    'where_region' => $values['where']['where_region'],
    'where_city' => $values['where']['where_city'],
    'where_postal_code' => (int)$values['where']['where_postal_code'],
    'where_postal_code_radius' => $values['where']['where_postal_code_radius'],
    'when_type_1' => $values['when']['when_type_1'],
    'when_before_after_1' => (int)$values['when']['when_before_after_1'],
    'when_date_1' => $values['when']['when_date_1'],
    'when_type_2' => $values['when']['when_type_2'],
    'when_before_after_2' => (int)$values['when']['when_before_after_2'],
    'when_date_2' => $values['when']['when_date_2'],
    'composite_query' => $values['composite_query'],
    'query_title' => $values['query_title'],
    'show_postal_code_search_box' => $values['show_postal_code_search_box'],
  );

  // Save types as CSV.
  $types_csv = '';
  foreach ($values['types'] as $type => $value) {
    $types_csv = $value ? $types_csv . "$type," : $types_csv;
  }
  $items['types'] = rtrim($types_csv, ',');

  form_set_value($element, $items, $form_state);

}

/**
 * Implements hook_field_formatter_info().
 */
function culturefeed_content_field_formatter_info() {

  return array(
    'culturefeed_content_default' => array(
      'label' => t('Default CultureFeed content formatter'),
      'field types' => array('culturefeed_content'),
    ),
  );

}

/**
 * Implements hook_field_formatter_view().
 */
function culturefeed_content_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {

  $element = array();
  switch ($display['type']) {

    case 'culturefeed_content_default':

      foreach ($items as $delta => $item) {

        $title = $item['title'];

        $sort = isset($item['sort']) ? $item['sort'] : CULTUREFEED_CONTENT_DEFAULT_SORT;
        $rows = isset($item['rows']) ? $item['rows'] : CULTUREFEED_CONTENT_DEFAULT_ROWS;

        $parameters = array();

        $search_type = culturefeed_get_searchable_type('activiteiten');
        $sort_options = culturefeed_search_ui_get_sort_options_for_page($search_type);
        foreach ($sort_options as $option) {
          if (isset($option['value'])) {
            if ($option['value'] == $sort) {
              $parameters[] = new \CultuurNet\Search\Parameter\Parameter('sort', $option['query']);
              break;
            }
          }
        }

        $parameters[] = new \CultuurNet\Search\Parameter\Rows($rows);
        $parameters[] = new \CultuurNet\Search\Parameter\Group();

        // Retrieve advanced query string and convert values to parameters.
        preg_match('/\[query\]=\((.*)\)/', $item['composite_query'], $matches);

        foreach (explode('%26', $matches[1]) as $filter) {
          $key_value = explode('=', $filter);

          switch ($key_value[0]) {
            case 'q':
              $parameters[] = new \CultuurNet\Search\Parameter\Query($key_value[1]);
              break;
            case 'zipcode':
              // Split code and radius.
              $split = explode('!', $key_value[1]);
              $parameters[] = new \CultuurNet\Search\Parameter\Spatial\Zipcode((int)$split[0], (int)$split[1]);
              break;
            case 'fq':
            default:
              $facetFilterQuery = new \CultuurNet\Search\Parameter\FilterQuery(trim($key_value[1], '()'));
              $parameters[] = $facetFilterQuery;
              break;
          }
        }

        // Execute search.
        try {
          $result = culturefeed_get_search_service()->search($parameters);
        }
        catch (Exception $e) {
          watchdog_exception('culturefeed_content', $e);
          return FALSE;
        }

        $search_results = $result->getItems();

        // Render the results.
        $build = array();

        if ($result->getTotalCount() > 0) {
          $build[] = array(
            '#theme' => 'culturefeed_content_title',
            '#title' => $title
          );

          foreach ($search_results as $search_result) {
            $build[] = array(
              '#theme' => 'culturefeed_' . $search_result->getType() . '_summary',
              '#item' => $search_result,
            );
          }

          if ($result->getTotalCount() > $rows) {

              $query = html_entity_decode($item['composite_query']);
              $query .= '&sort=' . $sort;

              $build[] = array(
                '#theme' => 'culturefeed_content_all_advanced_query_results_link',
                '#query' => $query,
                '#show_postal_code_search_box' => (int)$item['show_postal_code_search_box']
              );

          }

        }

        else {

          $build[] = array(
            '#theme' => 'culturefeed_content_empty_text',
          );

        }

        $element[$delta] = $build;

      }
      break;

  }
  return $element;

}

/**
 * Implements hook_field_info().
 */
function culturefeed_content_field_info() {

  return array(
    'culturefeed_content' => array(
      'label' => t('CultureFeed content'),
      'description' => t('Renders a CultureFeed search.'),
      'settings' => array(),
      'default_widget' => 'culturefeed_content_default',
      'default_formatter' => 'culturefeed_content_default',
    ),
  );

}

/**
 * Implements hook_field_is_empty().
 */
function culturefeed_content_field_is_empty($item, $field) {

  if (empty($item)) {
    return TRUE;
  }
  return FALSE;

}

/**
 * Implements hook_field_widget_form().
 */
function culturefeed_content_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta, $element) {
  $title = isset($items[$delta]['title']) ? $items[$delta]['title'] : '';
  $query_string = isset($items[$delta]['query_string']) ? $items[$delta]['query_string'] : '';
  $filter_query = isset($items[$delta]['filter_query']) ? $items[$delta]['filter_query'] : '';
  $rows = isset($items[$delta]['rows']) ? $items[$delta]['rows'] : '';
  $sort = isset($items[$delta]['sort']) ? $items[$delta]['sort'] : '';
  $where_type = isset($items[$delta]['where_type']) ? $items[$delta]['where_type'] : 'all';
  $where_equal = isset($items[$delta]['where_equal']) ? $items[$delta]['where_equal'] : 0;
  $where_region = isset($items[$delta]['where_region']) ? $items[$delta]['where_region'] : '';
  $where_city = isset($items[$delta]['where_city']) ? $items[$delta]['where_city'] : '';
  $where_postal_code = isset($items[$delta]['where_postal_code']) ? $items[$delta]['where_postal_code'] : '';
  $where_postal_code_radius = isset($items[$delta]['where_postal_code_radius']) ? $items[$delta]['where_postal_code_radius'] : 5;
  $when_type_1 = isset($items[$delta]['when_type_1']) ? $items[$delta]['when_type_1'] : 'all';
  $when_before_after_1 = isset($items[$delta]['when_before_after_1']) ? $items[$delta]['when_before_after_1'] : 0;
  $when_date_1 = isset($items[$delta]['when_date_1']) ? $items[$delta]['when_date_1'] : '';
  $when_type_2 = isset($items[$delta]['when_type_2']) ? $items[$delta]['when_type_2'] : 'all';
  $when_before_after_2 = isset($items[$delta]['when_before_after_2']) ? $items[$delta]['when_before_after_2'] : 0;
  $when_date_2 = isset($items[$delta]['when_date_2']) ? $items[$delta]['when_date_2'] : '';
  $query_title = isset($items[$delta]['query_title']) ? $items[$delta]['query_title'] : '';
  $show_postal_code_search_box = isset($items[$delta]['show_postal_code_search_box']) ? $items[$delta]['show_postal_code_search_box'] : '';

  // Return types CSV to array.
  $types = isset($items[$delta]['types']) ? explode(',', $items[$delta]['types']) : [];

  $field_parents = $element['#field_parents'];
  $field_name = $element['#field_name'];
  $language = $element['#language'];
  $parents = array_merge($field_parents, array($field_name, $language, $delta));
  $field_name_base = $field_name . "[$language]" . "[$delta";

  $what_category_rows = [];

  if (isset($form_state['values']['field_zoekopdracht'])) {
    if (!empty(unserialize($form_state['values']['field_zoekopdracht'][LANGUAGE_NONE][0]['what_categories']))) {
      $what_category_rows = _culturefeed_convert_serialized_categories_to_rows($form_state['values']['field_zoekopdracht'][LANGUAGE_NONE][0]['what_categories']);
    }
    elseif (!empty($items[$delta]['what_categories'])) {
      $what_category_rows = _culturefeed_convert_serialized_categories_to_rows($items[$delta]['what_categories']);
    }
  }

  // Check triggering element to possibly add an empty row
  if (isset($form_state['triggering_element']) && $form_state['triggering_element']['#name'] == 'what-add-category') {
    $what_category_rows[] = [];
  }

  // Check triggering element to possibly remove the last row
  if (isset($form_state['triggering_element']) && $form_state['triggering_element']['#name'] == 'what-remove-category') {
    array_pop($what_category_rows);
  }

  $element['wrapper'] = array(
    '#title' => t('CultureFeed content'),
    '#type' => 'fieldset',
  );

  $element['wrapper']['title'] = array(
    '#default_value' => $title,
    '#required' => $element['#required'],
    '#title' => t('Title'),
    '#type' => 'textfield',
    '#maxlength' => 255,
  );

  $element['wrapper']['query_string'] = array(
    '#default_value' => $query_string,
    '#required' => $element['#required'],
    '#title' => t('Keywords'),
    '#description' => t('Use * as a wildcard to search on parts of a word, e.g. <strong>*speeltuin, sinterklaas*</strong>.<br> Combine multiple terms with AND, OR and through using brackets, e.g. <strong>(workshop OR cursus) AND keramiek*</strong>.<br> Exact combinations need to use double qoutes, e.g. <strong>"dag van de wetenschap"</strong>.'),
    '#type' => 'textfield',
    '#maxlength' => 1000,
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['filter_query'] = array(
    '#default_value' => $filter_query,
    '#required' => $element['#required'],
    '#title' => t('Custom filters'),
    '#description' => t('Add extra parameters or your own advanced filter query, e.g. price:0 or hasimage:true'),
    '#type' => 'textfield',
    '#maxlength' => 1000,
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['rows'] = array(
    '#default_value' => $rows,
    '#required' => $element['#required'],
    '#title' => t('Rows'),
    '#description' => t('Number of results to show, defaults to "10"'),
    '#type' => 'textfield',
  );

  // Sort.
  $search_type = culturefeed_get_searchable_type('activiteiten');
  $sort_options = culturefeed_search_ui_get_sort_options_for_page($search_type);
  $options = array();

  foreach ($sort_options as $key => $option) {

    if ($key === 'default') {
      continue;
    }
    $options[$option['value']] = $option['label'];

  }

  $element['wrapper']['sort'] = array(
    '#default_value' => $sort,
    '#options' => $options,
    '#required' => $element['#required'],
    '#title' => t('Sort'),
    '#type' => 'radios',
  );

  $element['wrapper']['types'] = array(
    '#type' => 'checkboxes',
    '#options' => [
      'event' => t('Event'),
      'actor' => t('Actor'),
      'production' => t('Production')
    ],
    '#description' => t('Selecting none means that all types will be shown.'),
    '#default_value' => $types,
    '#title' => t('Type'),
    '#required' => $element['#required'],
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  // "Categories" fieldset (What)

  $element['wrapper']['what'] = array(
    '#title' => t('Categories'),
    '#type' => 'fieldset',
    '#attributes' => ['class' => 'fieldset-query-builder'],
    '#prefix' => '<div id="categories_fieldset">',
    '#suffix' => '</div>',
  );

  // Possibly add multiple rows to the existing element.
  if (empty($what_category_rows)) {
    $element = _culturefeed_add_builder_category_row($element, $field_name_base);
  }
  else {
    foreach($what_category_rows as $i => $values) {
      $element = _culturefeed_add_builder_category_row($element, $field_name_base, $i, $values);
    }
  }

  $element['wrapper']['what']['add_category'] = array(
    '#name' => 'what-add-category',
    '#type' => 'submit',
    '#value' => t('Submit'),
    '#submit' => array('culturefeed_content_widget_add_remove_category_submit'),
    '#limit_validation_errors' => array($parents),
    '#states' => array(
      'invisible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][what][what_type_0]\"]" => array('value' => 'all'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_rebuild_categories',
      'wrapper' => 'categories_fieldset',
    ),
  );

  $element['wrapper']['what']['remove_category'] = array(
    '#name' => 'what-remove-category',
    '#type' => 'submit',
    '#value' => t('Remove'),
    '#submit' => array('culturefeed_content_widget_add_remove_category_submit'),
    '#limit_validation_errors' => array($parents),
    '#ajax' => array(
      'callback' => '_culturefeed_rebuild_categories',
      'wrapper' => 'categories_fieldset',
    ),
  );

  // Hide "remove" button when there are fewer than 2 category field rows.
  if (!isset($element['wrapper']['what']['what_type_1'])) {
    $element['wrapper']['what']['remove_category']['#access'] = FALSE;
  }

  // "Where" fieldset.

  $element['wrapper']['where'] = array(
    '#title' => t('Where'),
    '#type' => 'fieldset',
    '#attributes' => ['class' => 'fieldset-query-builder']
  );

  $element['wrapper']['where']['where_type'] = array(
    '#type' => 'select',
    '#options' => [
      'all' => t('Alle'),
      'region' => t('Region'),
      'city' => t('City or municipality'),
      'postal_code' => t('Postal code + radius'),
    ],
    '#default_value' => $where_type,
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['where']['where_equal'] = array(
    '#type' => 'select',
    '#options' => [
      t('is equal to'),
      t('is not equal to')
    ],
    '#default_value' => $where_equal,
    '#states' => array(
      'visible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][where][where_type]\"]" => array('value' => 'region'),
        ),
        array(
          ":input[name=\"$field_name_base][wrapper][where][where_type]\"]" => array('value' => 'city'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  // Retrieve region options from DB.
  $region_options = ['all' => t('Alle')];
  $region_terms = culturefeed_search_get_terms_by_hierarchy_depth(2, 'flandersregion', culturefeed_search_get_preferred_language(), 'name');

  foreach ($region_terms as $term) {
    $region_options[$term->tid] = $term->name;
  }

  $element['wrapper']['where']['where_region'] = array(
    '#type' => 'select',
    '#options' => $region_options,
    '#default_value' => $where_region,
    '#states' => array(
      'visible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][where][where_type]\"]" => array('value' => 'region'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  // Retrieve city options from DB.
  $city_options = ['all' => t('Alle')];
  $city_terms = culturefeed_search_get_terms_by_hierarchy_depth(2, 'flandersregion', culturefeed_search_get_preferred_language(), 'name');

  foreach ($city_terms as $term) {
    $city_options[$term->tid] = $term->name;
  }

  $element['wrapper']['where']['where_city'] = array(
    '#type' => 'select',
    '#options' => $city_options,
    '#default_value' => $where_city,
    '#states' => array(
      'visible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][where][where_type]\"]" => array('value' => 'city'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['where']['where_postal_code'] = array(
    '#type' => 'textfield',
    '#size' => 10,
    '#default_value' => $where_postal_code,
    '#maxlength' => 255,
    '#states' => array(
      'visible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][where][where_type]\"]" => array('value' => 'postal_code'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['where']['where_postal_code_radius'] = array(
    '#type' => 'select',
    '#options' => [
      5 => '+5 km',
      10 => '+10 km',
      15 => '+15 km',
      20 => '+20 km'
    ],
    '#default_value' => $where_postal_code_radius,
    '#states' => array(
      'visible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][where][where_type]\"]" => array('value' => 'postal_code'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  // "When" fieldset.

  $before_after_options = [
    t('before'),
    t('after')
  ];

  $element['wrapper']['when'] = array(
    '#title' => t('When'),
    '#type' => 'fieldset',
    '#description' => t('These filters only apply to events.'),
    '#attributes' => ['class' => 'fieldset-query-builder'],
  );

  $element['wrapper']['when']['when_type_1'] = array(
    '#type' => 'select',
    '#options' => [
      'all' => t('Alle'),
      'startdate' => t('Start date'),
      'enddate' => t('End date'),
    ],
    '#default_value' => $when_type_1,
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['when']['when_before_after_1'] = array(
    '#type' => 'select',
    '#options' => $before_after_options,
    '#default_value' => $when_before_after_1,
    '#states' => array(
      'invisible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][when][when_type_1]\"]" => array('value' => 'all'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['when']['when_date_1'] = array(
    '#type' => 'date_popup',
    '#date_year_range' => '-2:+2',
    '#date_format' => 'd-m-Y',
    '#default_value' => $when_date_1,
    '#date_label_position' => 'none',
    '#states' => array(
      'invisible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][when][when_type_1]\"]" => array('value' => 'all'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['when']['when_type_2'] = array(
    '#type' => 'select',
    '#options' => [
      'all' => t('Alle'),
      'startdate' => t('Start date'),
      'enddate' => t('End date'),
    ],
    '#default_value' => $when_type_2,
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['when']['when_before_after_2'] = array(
    '#type' => 'select',
    '#options' => $before_after_options,
    '#default_value' => $when_before_after_2,
    '#states' => array(
      'invisible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][when][when_type_2]\"]" => array('value' => 'all'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['when']['when_date_2'] = array(
    '#type' => 'date_popup',
    '#date_year_range' => '-2:+2',
    '#date_format' => 'd-m-Y',
    '#default_value' => $when_date_2,
    '#date_label_position' => 'none',
    '#states' => array(
      'invisible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][when][when_type_2]\"]" => array('value' => 'all'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['composite_query'] = array(
    '#type' => 'textarea',
    '#title' => t('Composite query'),
    '#disabled' => TRUE,
    '#resizable' => FALSE,
    '#prefix' => '<div id="advanced_query_field">',
    '#suffix' => '</div>',
  );

  $build_values = isset($form_state['values']['field_zoekopdracht'][LANGUAGE_NONE][0]) ? $form_state['values']['field_zoekopdracht'][LANGUAGE_NONE][0] : $items[0];
  $element['wrapper']['composite_query']['#default_value'] = _culturefeed_build_advanced_query($build_values);

  $element['wrapper']['query_title'] = array(
    '#type' => 'textfield',
    '#default' => $query_title,
    '#title' => t('Query title'),
    '#required' => $element['#required'],
    '#maxlength' => 255,
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['show_postal_code_search_box'] = array(
    '#type' => 'checkbox',
    '#default_value' => $show_postal_code_search_box,
    '#title' => t('Show search box to filter by postal code'),
  );

  $element['#element_validate'] = array('culturefeed_content_field_culturefeed_content_validate');

  return $element;
}

function culturefeed_content_widget_add_remove_category_submit($form, &$form_state) {
  $form_state['rebuild'] = TRUE;
}

/**
 * Add a category row to the query builder categories field.
 *
 * @param $id
 * @param array $values
 *
 * @return string
 */
function _culturefeed_add_builder_category_row($element, $field_name_base, $id = 0, $values = []) {
  // Check values for defaults.
  $default_type = (isset($values['type']) ? $values['type'] : 'all');
  $default_equal = (isset($values['equal']) ? $values['equal'] : 0);
  $default_ids = (isset($values['ids']) ? $values['ids'] : '');

  // Build category type options.
  $selectable_categories = ['eventtype', 'theme', 'actortype', 'facility'];
  $domains = culturefeed_search_get_domains();
  $category_type_options = ['all' => t('Alle')];

  foreach ($selectable_categories as $category) {
    $category_type_options[$category] = $domains[$category];
  }

  $element['wrapper']['what']["what_type_$id"] = array(
    '#type' => 'select',
    '#options' => $category_type_options,
    '#default_value' => $default_type,
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  $element['wrapper']['what']["what_equal_$id"] = array(
    '#type' => 'select',
    '#options' => [
      t('is equal to'),
      t('is not equal to')
    ],
    '#default_value' => $default_equal,
    '#states' => array(
      'invisible' => array(
        array(
          ":input[name=\"$field_name_base][wrapper][what][what_type_$id]\"]" => array('value' => 'all'),
        ),
      ),
    ),
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_composite_query',
      'wrapper' => 'advanced_query_field',
      'progress' => array('type' => 'none')
    ),
  );

  // Build select fields for each category.
  foreach ($selectable_categories as $category) {
    $category_options = culturefeed_search_get_categories_by_domain($category);

    $element['wrapper']['what']["what_$category" . "_$id"] = array(
      '#type' => 'select',
      '#options' => $category_options,
      '#multiple' => TRUE,
      '#validated' => TRUE, // Fix for multiselect + ajax issue
      '#states' => array(
        'visible' => array(
          array(
            ":input[name=\"$field_name_base][wrapper][what][what_type_$id]\"]" => array('value' => $category),
          ),
        ),
      ),
      '#ajax' => array(
        'callback' => '_culturefeed_ajax_rebuild_composite_query',
        'wrapper' => 'advanced_query_field',
        'progress' => array('type' => 'none')
      ),
    );

    if ($category == $default_type && $default_type !== 'all') {
      $element['wrapper']['what']["what_$category" . "_$id"]['#default_value'] = $default_ids;
    }
  }

  return $element;
}

/**
 * Unserialize categories form values and convert to custom row value arrays.
 *
 * @param $serialized_values
 *
 * @return array
 */
function _culturefeed_convert_serialized_categories_to_rows ($serialized_values) {
  $rows = [];

  $values = unserialize($serialized_values);

  for ($i = 0; $i >= 0; $i++) {
    if (isset($values["what_type_$i"])) {
      if ($values["what_type_$i"] !== 'all') {

        switch ($values["what_type_$i"]) {
          case 'eventtype':
            $ids = $values["what_eventtype_$i"];
            break;
          case 'theme':
            $ids = $values["what_theme_$i"];
            break;
          case 'actortype':
            $ids = $values["what_actortype_$i"];
            break;
          case 'facility':
            $ids = $values["what_facility_$i"];
            break;
          default:
            $ids = [];
            break;
        }

        $rows[] = [
          'type' => $values["what_type_$i"],
          'equal' => $values["what_equal_$i"],
          'ids' => $ids
        ];
      }
      else {
        $rows[] = [];
      }
    }
    else {
      break;
    }
  }

  return $rows;
}

/**
 * Build an advanced query string based on the current builder values.
 *
 * @param $values
 *
 * @return string
 */
function _culturefeed_build_advanced_query($values) {
  $title = !empty($values['query_title']) ? $values['query_title'] : t('Advanced query filter');
  $query_param = !empty($values['query_string']) ? _culturefeed_search_ui_sanitize_query_term($values['query_string']) : '*:*';
  $advanced_query = "advanced_query[title]=$title&advanced_query[query]=(q=$query_param";

  // Types.
  $types = isset($values['types']) && !empty($values['types']) ? explode(',', $values['types']) : null;
  if ($types) {
    foreach ($values['types'] as $type => $value) {
      if ($value) {
        $types[] = $type;
      }
    }
  }
  else {
    $types = ['event', 'actor', 'production'];
  }

  $type_filters = '';

  foreach ($types as $type) {
    if (!empty($type_filters)) {
      $type_filters .= ' OR ';
    }
    $type_filters .= "type:$type";
  }

  $advanced_query .= "%26fq=($type_filters)";

  if (!empty($values['filter_query'])) {
    $advanced_query .= '%26fq=(' . $values['filter_query'] . ')';
  }

  // Categories query.
  $advanced_query .= _culturefeed_build_categories_query(unserialize($values['what_categories']));

  // Where.
  switch ($values['where_type']) {
    case 'region':
      $region = $values['where_region'];
      if ($region !== 'all') {
        $advanced_query .= $values['where_equal'] ? "%26fq=(NOT category_flandersregion_id:$region)" : "%26fq=(category_flandersregion_id:$region)";
      }
      break;
    case 'city':
      $city = $values['where_city'];
      if ($city !== 'all') {
        $advanced_query .= $values['where_equal'] ? "%26fq=(NOT category_flandersregion_id:$city)" : "%26fq=(category_flandersregion_id:$city)";
      }
      break;
    case 'postal_code':
      $postal_code = $values['where_postal_code'];
      $radius = $values['where_postal_code_radius'] . 'km';
      $advanced_query .= $values['where_equal'] ? "%26fq=(NOT zipcode:$postal_code)" : "%26zipcode=$postal_code!$radius";
      break;
  }

  // When.
  if ($values['when_date_1'] || $values['when_date_2']) {
    // To make the checking easier, we set type to 'all' if there is no corresponding date value yet.
    $values['when_type_1'] = $values['when_date_1'] ? $values['when_type_1'] : 'all';
    $values['when_type_2'] = $values['when_date_2'] ? $values['when_type_2'] : 'all';

    $combined_when_type = $values['when_type_1'] . '|' . $values['when_type_2'];
    $ba_1 = $values['when_before_after_1']; // 0 = before, 1 = after.
    $ba_2 = $values['when_before_after_2'];

    $date_1 = $values['when_date_1'] ? DateTime::createFromFormat('Y-m-d', $values['when_date_1']) : null;
    $date_2 = $values['when_date_2'] ? DateTime::createFromFormat('Y-m-d', $values['when_date_2']) : null;

    switch ($combined_when_type) {
      case 'startdate|all':
      case 'enddate|all':
        $advanced_query .= $ba_1 ? create_date_filter_param($values['when_type_1'], $date_1) : create_date_filter_param($values['when_type_1'], null, $date_1);
        break;
      case 'all|startdate':
      case 'all|enddate':
        $advanced_query .= $ba_2 ? create_date_filter_param($values['when_type_2'], $date_2) : create_date_filter_param($values['when_type_2'], null, $date_2);
        break;
      case 'startdate|startdate':
      case 'enddate|enddate':
        if ($ba_1 == $ba_2) {
          $advanced_query .= $ba_1 ? create_date_filter_param($values['when_type_1'], $date_1) : create_date_filter_param($values['when_type_1'], null, $date_1);
          $advanced_query .= $ba_2 ? create_date_filter_param($values['when_type_2'], $date_2) : create_date_filter_param($values['when_type_2'], null, $date_2);
        }
        else {
          $advanced_query .= $ba_1 && !$ba_2 ? create_date_filter_param($values['when_type_1'], $date_1, $date_2) : create_date_filter_param($values['when_type_1'], $date_2, $date_1);
        }
        break;
      case 'startdate|enddate':
      case 'enddate|startdate':
        $advanced_query .= $ba_1 ? create_date_filter_param($values['when_type_1'], $date_1) : create_date_filter_param($values['when_type_1'], null, $date_1);
        $advanced_query .= $ba_2 ? create_date_filter_param($values['when_type_2'], $date_2) : create_date_filter_param($values['when_type_2'], null, $date_2);
        break;
    }
  }

  return $advanced_query . ')';
}

/**
 * Build the categories query string based on the current builder values.
 *
 * @param $values
 *
 * @return string
 */
function _culturefeed_build_categories_query($values) {
  $query = '';

  // Loop through all possible field rows.
  for ($i = 0; $i >= 0; $i++) {

    if (!isset($values["what_type_$i"]) || $values["what_type_$i"] == 'all') {
      break;
    }

    $type = $values["what_type_$i"];

    $selected = array_values($values["what_$type" . "_$i"]);

    if (!empty($selected)) {
      $not_equal = (int)$values["what_equal_$i"];

      $query .= '%26fq=(';

      for ($j = 0; $j<count($selected); $j++) {

        $cat_id = $selected[$j];

        // Check for possible grouped values and split them up.
        if (strpos($cat_id, ',')) {
          $cat_ids = explode(',', $cat_id);
          $selected = array_merge($selected, $cat_ids);
          continue;
        }

        $query .= ($not_equal ? 'NOT ' : '');

        $query .= "category_$type" ."_id:$cat_id";

        if(count($selected)-1 > $j) {
          $query .= ' OR ';
        }
        else {
          continue;
        }
      }

      $query .= ')';
    }
    else {
      break;
    }
  }

  return $query;
}

/**
 * Returns a date filter query parameter string for the advanced query.
 *
 * @param string $type
 * @param null $date_1
 * @param null $date_2
 *
 * @return string
 */
function create_date_filter_param ($type = 'startdate', $date_1 = null, $date_2 = null) {
  if ($date_1) {
    $date_1->setTime(0, 0, 0);
    $value1 = gmdate('Y-m-d\TH:i:s\Z', $date_1->getTimestamp());
  }
  else {
    $value1 = '*';
  }

  if ($date_2) {
    $date_2->setTime(23, 59, 59);
    $value2 = gmdate('Y-m-d\TH:i:s\Z', $date_2->getTimestamp());
  }
  else {
    $value2 = '*';
  }

  return "%26fq=($type:[$value1 TO $value2])";
}

/**
 * Rebuild the categories field.
 */
function _culturefeed_rebuild_categories($form, &$form_state) {
  return $form['field_zoekopdracht'][LANGUAGE_NONE][0]['wrapper']['what'];
}

/**
 * Rebuild the composite_query field.
 */
function _culturefeed_ajax_rebuild_composite_query($form, &$form_state) {
  return $form['field_zoekopdracht'][LANGUAGE_NONE][0]['wrapper']['composite_query'];
}

/**
 * Form constructor for the contextual search box form.
 *
 * @param array $form
 *   The form.
 * @param array $form_state
 *   The form state.
 *
 * @return array
 *   The form.
 */
function culturefeed_content_contextual_search_box_form($form, $form_state, $query, $show_postal_code_filter, $link_text) {

  $form['#attached']['js'] = [
    drupal_get_path('module', 'culturefeed_content') . '/js/contextual_search_box.js',
  ];

  $postal_code = !empty($form_state['values']['postal_code']) ? $form_state['values']['postal_code'] : '1000';

  $query_params = $query;
  if (isset($form_state['triggering_element']) && $form_state['triggering_element']['#name'] == 'filter_postal_code') {
    $query_params = $form_state['triggering_element']['#value'] == 'on' ? "$query&location=$postal_code&distance=10" : $query;
  }

  $form['show_more_link'] = array(
    '#type' => 'markup',
    '#markup' => "<a href=\"/agenda/search?$query_params\" class=\"btn btn-primary\">$link_text</a>",
    '#prefix' => '<div id="show_more_link">',
    '#suffix' => '</div>',
  );

  if ($show_postal_code_filter) {
    $return_key = 'filter_postal_code';
    $form['filter_postal_code'] = array(
      '#type' => 'radio',
      '#description' => t('Only show tips in my neighbourhood: <em>@postal_code</em>. <a href="" id="toggle_postal_code">modify postal code</a>', array(
        '@postal_code' => $postal_code,
      )),
      '#return_value' => $return_key,
      '#default_value' => $form_state['values']['filter_postal_code'] == $return_key ? $return_key : FALSE,
      '#prefix' => '<div id="filter_postal_code">',
      '#suffix' => '</div>',
      '#ajax' => array(
        'callback' => '_culturefeed_ajax_rebuild_more_tips_link',
        'wrapper' => 'show_more_tips_button',
        'progress' => ['type' => 'none']
      ),
    );
  }

  $form['postal_code_container'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => ['postal-code-container'],
      'style' => 'display: none;'
    ),
  );

  $form['postal_code_container']['postal_code'] = array(
    '#type' => 'textfield',
    '#title' => t('Postal code'),
    '#size' => 10,
    '#ajax' => array(
      'callback' => '_culturefeed_ajax_rebuild_more_tips_link',
      'wrapper' => 'show_more_tips_button',
      'progress' => ['type' => 'none']
    ),
  );

  return $form;
}

/**
 * Rebuild the more tips link.
 */
function _culturefeed_ajax_rebuild_more_tips_link($form, &$form_state) {
  return array(
    '#type' => 'ajax',
    '#commands' => array(
      ajax_command_replace("#show_more_link", render($form['show_more_link'])),
      ajax_command_replace("#filter_postal_code", render($form['filter_postal_code']))
    )
  );
}

/**
 * Implements hook_field_widget_info().
 */
function culturefeed_content_field_widget_info() {

  return array(
    'culturefeed_content_default' => array(
      'label' => t('Default CultureFeed content widget'),
      'field types' => array('culturefeed_content'),
      'settings' => array(),
      'behaviors' => array(
        'multiple values' => FIELD_BEHAVIOR_DEFAULT,
        'default value' => FIELD_BEHAVIOR_DEFAULT,
      ),
    ),
  );

}

/**
 * Implements hook_theme().
 */
function culturefeed_content_theme() {

  return array(
    'culturefeed_content_empty_text' => array(
      'variables' => array(
        'empty_text' => t('No results found.'),
        'classes' => array('alert', 'alert-info'),
      ),
    ),
    'culturefeed_content_all_advanced_query_results_link' => array(
      'variables' => array(
        'link_text' => t('Show more'),
        'query' => '',
        'show_postal_code_search_box' => 0,
        'classes' => array('cf-content-all-results-link'),
      ),
    ),
    'culturefeed_content_title' => array(
      'variables' => array(
        'title' => '',
        'classes' => array('cf-content-title'),
      ),
    )
  );

}

/**
 * Returns HTML for the all advanced query results link.
 *
 * @param array $variables
 *   The variables.
 *
 * @return string
 *   The HTML.
 */
function theme_culturefeed_content_all_advanced_query_results_link(array $variables) {

  $form = drupal_get_form('culturefeed_content_contextual_search_box_form', $variables['query'], $variables['show_postal_code_search_box'], $variables['link_text']);

  return drupal_render($form);

}

/**
 * Returns HTML for the empty text.
 *
 * @param array $variables
 *   The variables.
 *
 * @return string
 *   The HTML.
 */
function theme_culturefeed_content_empty_text(array $variables) {

  $build = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => $variables['classes'],
    ),
    'empty_text' => array(
      '#markup' => $variables['empty_text'],
    ),
  );

  return drupal_render($build);

}

/**
 * Returns HTML for the title.
 *
 * @param array $variables
 *   The variables.
 *
 * @return string
 *   The HTML.
 */
function theme_culturefeed_content_title(array $variables) {

  if (empty($variables['title'])) {
    $variables['title'] = t('Our selection');
  }

  $build = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => $variables['classes'],
    ),
    'title' => array(
      '#markup' => $variables['title'],
    ),
  );

  return drupal_render($build);
}
